stages: [test, dist]

before_script:
    - export MAKEFLAGS="-j$(mk/nproc.sh) -Otarget" V=1 VERBOSE=1

test:debian:
    stage: test
    image: registry.gitlab.com/craigbarnes/dockerfiles/lua-testing
    coverage: '/^Total\s+\d+\s+\d+\s+(\d+\.\d+\%)$/'
    script:
        - make vars
        - make build-all
        - make check-all check-luajit

        - make rockspecs
        - make clean-obj
        - luarocks-5.3 make gumbo-*.53-1.rockspec
        - lua5.3 -e 'require "gumbo"'
        - make clean-obj
        - luarocks-5.2 make gumbo-*.52-1.rockspec
        - lua5.2 -e 'require "gumbo"'
        - make clean-obj
        - luarocks-5.1 make gumbo-*.51-1.rockspec
        - lua5.1 -e 'require "gumbo"'

        - make clean-obj
        - make coverage.txt
        - sed -n '/^File  *Hits .*Coverage$/,/^Total.*%$/p' coverage.txt

test:debian:gtest:
    stage: test
    image: registry.gitlab.com/craigbarnes/dockerfiles/cxxdev-debian
    script:
        - curl -LO https://github.com/google/googletest/archive/release-1.8.0.tar.gz
        - tar -xzf release-1.8.0.tar.gz
        - export GTEST_DIR=googletest-release-1.8.0/googletest
        - g++ -isystem $GTEST_DIR/include -I$GTEST_DIR -pthread -c $GTEST_DIR/src/gtest-all.cc
        - g++ -isystem $GTEST_DIR/include -I$GTEST_DIR -pthread -c $GTEST_DIR/src/gtest_main.cc
        - ar -rv gtest.a gtest-all.o
        - ar -rv gtest_main.a gtest_main.o

        - export GTEST_CXXFLAGS="-isystem $GTEST_DIR/include -pthread"
        - export GTEST_LDLIBS="gtest.a gtest_main.a"
        - export GTEST_LDFLAGS="-pthread"
        - make vars
        - make check-lib

test:alpine:
    stage: test
    image: registry.gitlab.com/craigbarnes/dockerfiles/cdev-alpine
    script: &SCRIPT
        - make vars
        - make build-all
        - make check-all

test:void-musl:
    stage: test
    image: registry.gitlab.com/craigbarnes/dockerfiles/cdev-void-musl
    script: *SCRIPT

pages:
    stage: dist
    image: registry.gitlab.com/craigbarnes/dockerfiles/pandoc
    artifacts: {paths: [public]}
    only: [master]
    script: &PAGES_SCRIPT
        - git fetch --tags
        - make docs doxygen dist
        - make check-dist

pages:non-master:
    stage: test
    image: registry.gitlab.com/craigbarnes/dockerfiles/pandoc
    except: [master]
    script: *PAGES_SCRIPT
